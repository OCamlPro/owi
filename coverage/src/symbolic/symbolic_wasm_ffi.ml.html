<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>symbolic_wasm_ffi.ml &mdash; Coverage report</title>
    <meta name="description" content="68.11% coverage in src/symbolic/symbolic_wasm_ffi.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/symbolic/</span>symbolic_wasm_ffi.ml
        </a>
      </h1>
      <h2>68.11%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:12.61%"></span>
      <span class="unvisited" style="top:13.51%"></span>
      <span class="unvisited" style="top:14.41%"></span>
      <span class="unvisited" style="top:14.86%"></span>
      <span class="unvisited" style="top:15.77%"></span>
      <span class="unvisited" style="top:16.22%"></span>
      <span class="unvisited" style="top:18.47%"></span>
      <span class="unvisited" style="top:18.92%"></span>
      <span class="unvisited" style="top:20.72%"></span>
      <span class="unvisited" style="top:21.17%"></span>
      <span class="unvisited" style="top:23.42%"></span>
      <span class="unvisited" style="top:24.77%"></span>
      <span class="unvisited" style="top:25.23%"></span>
      <span class="unvisited" style="top:25.68%"></span>
      <span class="unvisited" style="top:26.13%"></span>
      <span class="unvisited" style="top:35.59%"></span>
      <span class="unvisited" style="top:36.04%"></span>
      <span class="unvisited" style="top:40.54%"></span>
      <span class="unvisited" style="bottom:49.55%"></span>
      <span class="unvisited" style="bottom:49.10%"></span>
      <span class="unvisited" style="bottom:48.65%"></span>
      <span class="unvisited" style="bottom:48.20%"></span>
      <span class="some-visited" style="bottom:44.59%"></span>
      <span class="unvisited" style="bottom:40.99%"></span>
      <span class="unvisited" style="bottom:40.54%"></span>
      <span class="unvisited" style="bottom:40.09%"></span>
      <span class="unvisited" style="bottom:39.19%"></span>
      <span class="some-visited" style="bottom:33.33%"></span>
      <span class="unvisited" style="bottom:30.63%"></span>
      <span class="unvisited" style="bottom:29.73%"></span>
      <span class="unvisited" style="bottom:29.28%"></span>
      <span class="unvisited" style="bottom:7.66%"></span>
      <span class="unvisited" style="bottom:6.31%"></span>
      <span class="unvisited" style="bottom:5.86%"></span>
      <span class="unvisited" style="bottom:4.50%"></span>
      <span class="unvisited" style="bottom:4.05%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span class="visited"> </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span class="unvisited"> </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span class="unvisited"> </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span class="unvisited"> </span>
<a id="L33"></a><span class="unvisited"> </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="unvisited"> </span>
<a id="L36"></a><span class="unvisited"> </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span class="unvisited"> </span>
<a id="L42"></a><span class="unvisited"> </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span class="unvisited"> </span>
<a id="L47"></a><span class="unvisited"> </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span class="visited"> </span>
<a id="L50"></a><span class="visited"> </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="unvisited"> </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span class="unvisited"> </span>
<a id="L56"></a><span class="unvisited"> </span>
<a id="L57"></a><span class="unvisited"> </span>
<a id="L58"></a><span class="unvisited"> </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span class="visited"> </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span class="visited"> </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span class="visited"> </span>
<a id="L72"></a><span class="visited"> </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span class="visited"> </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="unvisited"> </span>
<a id="L80"></a><span class="unvisited"> </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span class="visited"> </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span class="visited"> </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="unvisited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span class="visited"> </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span class="unvisited"> </span>
<a id="L113"></a><span class="unvisited"> </span>
<a id="L114"></a><span class="unvisited"> </span>
<a id="L115"></a><span class="unvisited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span class="visited"> </span>
<a id="L120"></a><span class="visited"> </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="some-visited"> </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="unvisited"> </span>
<a id="L132"></a><span class="unvisited"> </span>
<a id="L133"></a><span class="unvisited"> </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span class="unvisited"> </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span class="visited"> </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span class="visited"> </span>
<a id="L144"></a><span class="visited"> </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span class="visited"> </span>
<a id="L147"></a><span class="visited"> </span>
<a id="L148"></a><span class="some-visited"> </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span class="unvisited"> </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span class="unvisited"> </span>
<a id="L157"></a><span class="unvisited"> </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span class="visited"> </span>
<a id="L162"></a><span class="visited"> </span>
<a id="L163"></a><span class="visited"> </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span > </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span > </span>
<a id="L171"></a><span > </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span class="visited"> </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span class="visited"> </span>
<a id="L185"></a><span > </span>
<a id="L186"></a><span class="visited"> </span>
<a id="L187"></a><span class="visited"> </span>
<a id="L188"></a><span class="visited"> </span>
<a id="L189"></a><span class="visited"> </span>
<a id="L190"></a><span class="visited"> </span>
<a id="L191"></a><span class="visited"> </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span class="visited"> </span>
<a id="L197"></a><span class="visited"> </span>
<a id="L198"></a><span class="visited"> </span>
<a id="L199"></a><span class="visited"> </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span > </span>
<a id="L202"></a><span > </span>
<a id="L203"></a><span > </span>
<a id="L204"></a><span > </span>
<a id="L205"></a><span class="unvisited"> </span>
<a id="L206"></a><span > </span>
<a id="L207"></a><span > </span>
<a id="L208"></a><span class="unvisited"> </span>
<a id="L209"></a><span class="unvisited"> </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span > </span>
<a id="L212"></a><span class="unvisited"> </span>
<a id="L213"></a><span class="unvisited"> </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span > </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span class="visited"> </span>
<a id="L218"></a><span class="visited"> </span>
<a id="L219"></a><span class="visited"> </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span > </span>
<a id="L222"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
</pre>
<pre><code class="ocaml">(* SPDX-License-Identifier: AGPL-3.0-or-later *)
(* Copyright © 2021-2024 OCamlPro *)
(* Written by the Owi programmers *)

module Expr = Smtml.Expr
module Choice = Symbolic_choice_with_memory
module Memory = Symbolic.Memory

(* The constraint is used here to make sure we don't forget to define one of the expected FFI functions, this whole file is further constrained such that if one function of M is unused in the FFI module below, an error will be displayed *)
module M :
  Wasm_ffi_intf.S0
    with type 'a t = 'a Choice.t
     and type memory = Memory.t
     and module Value = Symbolic_value = struct
  type 'a t = 'a Choice.t

  type memory = Memory.t

  module Value = Symbolic_value

  let covered_labels = Hashtbl.creat<span data-count="883">e</span> 16

  let cov_lock = Mutex.creat<span data-count="883">e</span> ()

  let in_seacoral_store =
    let seacoral_store =
      Option.bind (Bos.OS.Env.va<span data-count="883">r</span> "SC_STORE_MAP_FILE") @@ fun path -&gt;
      <span data-count="0">l</span>et seacoral_size =
        match Bos.OS.Env.var "SC_LABEL_COUNT" with
        | <span data-count="0">S</span>ome s -&gt; begin
          match int_of_string_opt s with
          | <span data-count="0">S</span>ome i -&gt; i
          | <span data-count="0">N</span>one -&gt; Fmt.failwit<span data-count="0">h</span> "SC_LABEL_COUNT should be a number"
        end
        | <span data-count="0">N</span>one -&gt;
          Fmt.failwit<span data-count="0">h</span> "SC_STORE_MAP_FILE specified but not SC_LABEL_COUNT"
      in
      (* we should only read from this fd, but we have to open it in O_RDWR
         because map_file needs it for resizing the array to fit seacoral_size elements *)
      let fd = Unix.openfile path [ O_RDWR ] 0o600 in
      <span data-count="0">a</span>t_exit (fun () -&gt; <span data-count="0">U</span>nix.close fd);
      <span data-count="0">l</span>et res =
        Unix.map_file fd Int8_unsigned Bigarray.c_layout true
          [| seacoral_size |]
      in
      <span data-count="0">L</span>og.app (fun m -&gt; <span data-count="0">m</span> "SC_STORE_MAP_FILE successfully mapped : %s" path);
      <span data-count="0">S</span>ome (fd, res)
    in
    <span data-count="883">f</span>un i -&gt;
      <span data-count="2">m</span>atch seacoral_store with
      | <span data-count="2">N</span>one -&gt; false
      | <span data-count="0">S</span>ome (fd, arr) -&gt; (
        try
          Unix.lockf fd F_RLOCK 0;
          <span data-count="0">l</span>et lbl_status = Bigarray.Genarray.get arr [| Int32.to_in<span data-count="0">t</span> i |] in
          <span data-count="0">U</span>nix.lockf fd F_ULOCK 0;
          <span data-count="0">l</span>bl_status &lt;&gt; 0
        with <span data-count="0">I</span>nvalid_argument _ -&gt; false )

  let assume (i : Value.int32) : unit Choice.t =
    <span data-count="589">C</span>hoice.assume @@ Value.I32.to_boo<span data-count="589">l</span> i

  let assert' (i : Value.int32) : unit Choice.t =
    <span data-count="96962">C</span>hoice.assertion @@ Value.I32.to_boo<span data-count="96962">l</span> i

  let symbol_bool () =
    <span data-count="4">C</span>hoice.with_new_symbol (Ty_bitv 1) (fun sym -&gt;
      <span data-count="4">E</span>xpr.cvtop (Ty_bitv 32) (Zero_extend 31) (Expr.symbo<span data-count="4">l</span> sym) )

  let symbol_invisible_bool () =
    <span data-count="1">C</span>hoice.with_new_invisible_symbol (Ty_bitv 1) (fun sym -&gt;
      <span data-count="1">E</span>xpr.cvtop (Ty_bitv 32) (Zero_extend 31) (Expr.symbo<span data-count="1">l</span> sym) )

  let symbol_i8 () =
    <span data-count="36">C</span>hoice.with_new_symbol (Ty_bitv 8) (fun sym -&gt;
      <span data-count="36">E</span>xpr.cvtop (Ty_bitv 32) (Zero_extend 24) (Expr.symbo<span data-count="36">l</span> sym) )

  let symbol_i16 () =
    <span data-count="0">C</span>hoice.with_new_symbol (Ty_bitv 16) (fun sym -&gt;
      <span data-count="0">E</span>xpr.cvtop (Ty_bitv 32) (Zero_extend 16) (Expr.symbo<span data-count="0">l</span> sym) )

  let symbol_i32 () = <span data-count="1176">C</span>hoice.with_new_symbol (Ty_bitv 32) Expr.symbol

  let symbol_i64 () = <span data-count="53">C</span>hoice.with_new_symbol (Ty_bitv 64) Expr.symbol

  let symbol_f32 () = <span data-count="62">C</span>hoice.with_new_symbol (Ty_fp 32) Expr.symbol

  let symbol_f64 () = <span data-count="59">C</span>hoice.with_new_symbol (Ty_fp 64) Expr.symbol

  let symbol_v128 () = <span data-count="0">C</span>hoice.with_new_symbol (Ty_bitv 128) Expr.symbol

  let symbol_range (lo : Value.int32) (hi : Value.int32) =
    <span data-count="12">l</span>et open Choice in
    let* x = symbol_i3<span data-count="12">2</span> () in
    <span data-count="12">l</span>et* () = assum<span data-count="12">e</span> (Value.I32.l<span data-count="12">e</span> lo x) in
    <span data-count="12">l</span>et+ () = assum<span data-count="12">e</span> (Value.I32.g<span data-count="12">t</span> hi x) in
    <span data-count="12">x</span>

  let abort () : unit Choice.t = <span data-count="2">C</span>hoice.stop

  let alloc m (base : Value.int32) (size : Value.int32) : Value.int32 Choice.t =
    <span data-count="9922">C</span>hoice.lift_mem @@ Memory.reallo<span data-count="9922">c</span> m ~ptr:base ~size

  let free m (ptr : Value.int32) : Value.int32 Choice.t =
    <span data-count="2539">C</span>hoice.lift_mem @@ Memory.fre<span data-count="2539">e</span> m ptr

  let exit (_p : Value.int32) : unit Choice.t = <span data-count="1">a</span>bort ()

  let in_replay_mode () = <span data-count="1">C</span>hoice.return @@ Smtml.Expr.valu<span data-count="1">e</span> (Smtml.Value.Int 0)

  let print_char (c : Value.int32) =
    <span data-count="0">l</span>et open Choice in
    let* c = select_i3<span data-count="0">2</span> c in
    <span data-count="0">L</span>og.app (fun m -&gt; <span data-count="0">m</span> "%c@?" (char_of_in<span data-count="0">t</span> (Int32.to_in<span data-count="0">t</span> c)));
    <span data-count="0">r</span>eturn ()

  let rec make_str m accu i =
    <span data-count="83">l</span>et open Choice in
    let* p = Memory.load_8_<span data-count="83">u</span> m (Value.const_i3<span data-count="83">2</span> i) in
    <span data-count="83">m</span>atch Smtml.Expr.view p with
    | <span data-count="83">V</span>al (Bitv bv) when Smtml.Bitvector.numbit<span data-count="83">s</span> bv = 32 -&gt;
      <span data-count="83">l</span>et c = Smtml.Bitvector.to_int32 bv in
      <span data-count="83">i</span>f Int32.g<span data-count="83">t</span> c 255<span data-count="0">l</span> || Int32.l<span data-count="83">t</span> c 0<span data-count="0">l</span> then <span data-count="0">t</span>rap `Invalid_character_in_memory
      else
        <span data-count="83">l</span>et ch = char_of_int (Int32.to_in<span data-count="83">t</span> c) in
        <span data-count="83">i</span>f Char.equal ch '\x00' then <span data-count="12">r</span>eturn (List.rev accu |&gt; <span data-count="12">A</span>rray.of_lis<span data-count="12">t</span>)
        else <span data-count="71">m</span>ake_str m (ch :: accu) (Int32.ad<span data-count="71">d</span> i (Int32.of_in<span data-count="71">t</span> 1))
    | _ -&gt; assert false

  let cov_label_is_covered id =
    <span data-count="0">l</span>et open Choice in
    let* id = select_i3<span data-count="0">2</span> id in
    <span data-count="0">r</span>eturn @@ Value.const_i3<span data-count="0">2</span> @@ Mutex.protect cov_loc<span data-count="0">k</span>
    @@ fun () -&gt;
    <span data-count="0">i</span>f Hashtbl.me<span data-count="0">m</span> covered_labels i<span data-count="0">d</span> || in_seacoral_stor<span data-count="0">e</span> i<span data-count="0">d</span> then <span data-count="0">1</span>l else <span data-count="0">0</span>l

  let cov_label_set m id ptr =
    <span data-count="2">l</span>et open Choice in
    let open Smtml in
    let id = Expr.simplify id in
    <span data-count="2">l</span>et ptr = Expr.simplify ptr in
    <span data-count="2">m</span>atch (Expr.vie<span data-count="2">w</span> id, Expr.vie<span data-count="2">w</span> ptr) with
    | <span data-count="2">V</span>al (Bitv id), Val (Bitv ptr)
      when Bitvector.numbit<span data-count="2">s</span> id = 32 &amp;&amp; <span data-count="2">B</span>itvector.numbit<span data-count="2">s</span> ptr = 32 -&gt;
      <span data-count="2">l</span>et id = Bitvector.to_int32 id in
      <span data-count="2">l</span>et ptr = Bitvector.to_int32 ptr in
      <span data-count="2">M</span>utex.protect cov_lock @@ fun () -&gt;
      <span data-count="2">i</span>f Hashtbl.me<span data-count="2">m</span> covered_labels i<span data-count="0">d</span> || in_seacoral_stor<span data-count="2">e</span> i<span data-count="0">d</span> then <span data-count="0">a</span>bort ()
      else
        <span data-count="2">l</span>et* chars = make_st<span data-count="2">r</span> m [] ptr in
        <span data-count="2">l</span>et str = String.init (Array.lengt<span data-count="2">h</span> chars) (Array.ge<span data-count="2">t</span> chars) in
        <span data-count="2">H</span>ashtbl.add covered_labels id str;
        <span data-count="2">a</span>dd_label (Int32.to_in<span data-count="2">t</span> id, str)
    | <span data-count="0">_</span> -&gt;
      Log.err (fun m -&gt;
        <span data-count="0">m</span> "cov_label_set: invalid type id:%a ptr:%a" Expr.pp id Expr.pp ptr );
      <span data-count="0">a</span>ssert false

  let open_scope m ptr =
    <span data-count="10">l</span>et open Choice in
    let* ptr = select_i3<span data-count="10">2</span> ptr in
    <span data-count="10">l</span>et* chars = make_st<span data-count="10">r</span> m [] ptr in
    <span data-count="10">l</span>et str = String.init (Array.lengt<span data-count="10">h</span> chars) (Array.ge<span data-count="10">t</span> chars) in
    <span data-count="10">o</span>pen_scope str

  let close_scope = Choice.close_scope
end

type extern_func = Symbolic.Extern_func.extern_func

open M
open Symbolic.Extern_func
open Symbolic.Extern_func.Syntax

let symbolic_extern_module =
  let functions =
    [ ("i8_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, symbol_i8))
    ; ("i16_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, symbol_i16))
    ; ("i32_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, symbol_i32))
    ; ("i64_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> i64, symbol_i64))
    ; ("f32_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> f32, symbol_f32))
    ; ("f64_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> f64, symbol_f64))
    ; ("v128_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> v128, symbol_v128))
    ; ("bool_symbol", Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, symbol_bool))
    ; ( "invisible_bool_symbol"
      , Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, symbol_invisible_bool) )
    ; ("range_symbol", Extern_func (i32 ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> i32, symbol_range))
    ; ("assume", Extern_func (i32 ^-&gt;<span data-count="883">.</span> unit, assume))
    ; ("assert", Extern_func (i32 ^-&gt;<span data-count="883">.</span> unit, assert'))
    ; ("in_replay_mode", Extern_func (unit ^-&gt;<span data-count="883">.</span> i32, in_replay_mode))
    ; ("print_char", Extern_func (i32 ^-&gt;<span data-count="883">.</span> unit, print_char))
    ; ( "cov_label_set"
      , Extern_func (memory ^-<span data-count="883">&gt;</span> i32 ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> unit, cov_label_set) )
    ; ("cov_label_is_covered", Extern_func (i32 ^-&gt;<span data-count="883">.</span> i32, cov_label_is_covered))
    ; ("open_scope", Extern_func (memory ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> unit, open_scope))
    ; ("close_scope", Extern_func (unit ^-&gt;<span data-count="883">.</span> unit, close_scope))
    ; ("alloc", Extern_func (memory ^-<span data-count="883">&gt;</span> i32 ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> i32, alloc))
    ; ("dealloc", Extern_func (memory ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> i32, free))
    ; ("abort", Extern_func (unit ^-&gt;<span data-count="883">.</span> unit, abort))
    ; ("exit", Extern_func (i32 ^-&gt;<span data-count="883">.</span> unit, exit))
    ]
  in
  { Link.functions }

let fd_write _ _ _ _ = <span data-count="0">a</span>ssert false

let proc_exit _ =
  <span data-count="0">L</span>og.warn (fun m -&gt; <span data-count="0">m</span> "used dummy proc_exit implementation");
  <span data-count="0">C</span>hoice.return ()

let random_get _ _ =
  <span data-count="0">L</span>og.warn (fun m -&gt; <span data-count="0">m</span> "used dummy random_get implementation");
  <span data-count="0">C</span>hoice.return @@ Symbolic_value.const_i3<span data-count="0">2</span> 0l

let wasi_snapshot_preview1 =
  let functions =
    [ ("fd_write", Extern_func (i32 ^-<span data-count="883">&gt;</span> i32 ^-<span data-count="883">&gt;</span> i32 ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> i32, fd_write))
    ; ("proc_exit", Extern_func (i32 ^-&gt;<span data-count="883">.</span> unit, proc_exit))
    ; ("random_get", Extern_func (i32 ^-<span data-count="883">&gt;</span> i32 ^-&gt;<span data-count="883">.</span> i32, random_get))
    ]
  in
  { Link.functions }
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
