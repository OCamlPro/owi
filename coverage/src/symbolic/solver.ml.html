<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>solver.ml &mdash; Coverage report</title>
    <meta name="description" content="78.57% coverage in src/symbolic/solver.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/symbolic/</span>solver.ml
        </a>
      </h1>
      <h2>78.57%</h2>
    </div>
    <div id="navbar">
      <span class="some-visited" style="top:14.14%"></span>
      <span class="unvisited" style="top:41.41%"></span>
      <span class="unvisited" style="bottom:46.46%"></span>
      <span class="some-visited" style="bottom:26.26%"></span>
      <span class="unvisited" style="bottom:19.19%"></span>
      <span class="unvisited" style="bottom:11.11%"></span>
      <span class="unvisited" style="bottom:9.09%"></span>
      <span class="unvisited" style="bottom:6.06%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span class="visited"> </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span class="visited"> </span>
<a id="L13"></a><span class="visited"> </span>
<a id="L14"></a><span class="some-visited"> </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span class="visited"> </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span class="visited"> </span>
<a id="L23"></a><span class="visited"> </span>
<a id="L24"></a><span class="visited"> </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span class="visited"> </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span class="visited"> </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span class="visited"> </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span class="unvisited"> </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span class="visited"> </span>
<a id="L51"></a><span class="visited"> </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="unvisited"> </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span class="visited"> </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="some-visited"> </span>
<a id="L74"></a><span class="visited"> </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span class="visited"> </span>
<a id="L79"></a><span > </span>
<a id="L80"></a><span class="unvisited"> </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span class="visited"> </span>
<a id="L86"></a><span > </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span class="unvisited"> </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="unvisited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="unvisited"> </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1"> 1</a>
<a href="#L2"> 2</a>
<a href="#L3"> 3</a>
<a href="#L4"> 4</a>
<a href="#L5"> 5</a>
<a href="#L6"> 6</a>
<a href="#L7"> 7</a>
<a href="#L8"> 8</a>
<a href="#L9"> 9</a>
<a href="#L10">10</a>
<a href="#L11">11</a>
<a href="#L12">12</a>
<a href="#L13">13</a>
<a href="#L14">14</a>
<a href="#L15">15</a>
<a href="#L16">16</a>
<a href="#L17">17</a>
<a href="#L18">18</a>
<a href="#L19">19</a>
<a href="#L20">20</a>
<a href="#L21">21</a>
<a href="#L22">22</a>
<a href="#L23">23</a>
<a href="#L24">24</a>
<a href="#L25">25</a>
<a href="#L26">26</a>
<a href="#L27">27</a>
<a href="#L28">28</a>
<a href="#L29">29</a>
<a href="#L30">30</a>
<a href="#L31">31</a>
<a href="#L32">32</a>
<a href="#L33">33</a>
<a href="#L34">34</a>
<a href="#L35">35</a>
<a href="#L36">36</a>
<a href="#L37">37</a>
<a href="#L38">38</a>
<a href="#L39">39</a>
<a href="#L40">40</a>
<a href="#L41">41</a>
<a href="#L42">42</a>
<a href="#L43">43</a>
<a href="#L44">44</a>
<a href="#L45">45</a>
<a href="#L46">46</a>
<a href="#L47">47</a>
<a href="#L48">48</a>
<a href="#L49">49</a>
<a href="#L50">50</a>
<a href="#L51">51</a>
<a href="#L52">52</a>
<a href="#L53">53</a>
<a href="#L54">54</a>
<a href="#L55">55</a>
<a href="#L56">56</a>
<a href="#L57">57</a>
<a href="#L58">58</a>
<a href="#L59">59</a>
<a href="#L60">60</a>
<a href="#L61">61</a>
<a href="#L62">62</a>
<a href="#L63">63</a>
<a href="#L64">64</a>
<a href="#L65">65</a>
<a href="#L66">66</a>
<a href="#L67">67</a>
<a href="#L68">68</a>
<a href="#L69">69</a>
<a href="#L70">70</a>
<a href="#L71">71</a>
<a href="#L72">72</a>
<a href="#L73">73</a>
<a href="#L74">74</a>
<a href="#L75">75</a>
<a href="#L76">76</a>
<a href="#L77">77</a>
<a href="#L78">78</a>
<a href="#L79">79</a>
<a href="#L80">80</a>
<a href="#L81">81</a>
<a href="#L82">82</a>
<a href="#L83">83</a>
<a href="#L84">84</a>
<a href="#L85">85</a>
<a href="#L86">86</a>
<a href="#L87">87</a>
<a href="#L88">88</a>
<a href="#L89">89</a>
<a href="#L90">90</a>
<a href="#L91">91</a>
<a href="#L92">92</a>
<a href="#L93">93</a>
<a href="#L94">94</a>
<a href="#L95">95</a>
<a href="#L96">96</a>
<a href="#L97">97</a>
<a href="#L98">98</a>
<a href="#L99">99</a>
</pre>
<pre><code class="ocaml">(* SPDX-License-Identifier: AGPL-3.0-or-later *)
(* Copyright Â© 2021-2024 OCamlPro *)
(* Written by the Owi programmers *)

type 'a solver_module = (module Smtml.Solver_intf.S with type t = 'a)

type t = S : ('a solver_module * 'a) -&gt; t [@@unboxed]

let instances = Atomic.mak<span data-count="751">e</span> []

let rec add_solver solver =
  <span data-count="2">l</span>et l = Atomic.get instances in
  <span data-count="2">l</span>et success = Atomic.compare_and_set instances l (solver :: l) in
  <span data-count="2">i</span>f not success then <span data-count="0">a</span>dd_solver solver

let fresh solver_ty () =
  <span data-count="601">l</span>et module Mapping = (val Smtml.Solver_dispatcher.mappings_of_solve<span data-count="601">r</span> solver_ty)
  in
  let module Mapping = Mapping.Fresh.Make () in
  let module Batch = Smtml.Solver.Cached (Mapping) in
  let solver_inst = Batch.create ~logic:QF_BVFP () in
  <span data-count="596">l</span>et solver = S ((module Batch), solver_inst) in
  if Log.is_bench_enabled () then <span data-count="2">a</span>dd_solve<span data-count="2">r</span> solver;
  <span data-count="596">s</span>olver

let check (S (solver_module, s)) pc =
  <span data-count="26342">l</span>et module Solver = (val solver_module) in
  Solver.check_set s pc

let model_of_path_condition (S (solver_module, s)) ~path_condition :
  Smtml.Model.t Option.t =
  <span data-count="242">l</span>et exception Unknown in
  let module Solver = (val solver_module) in
  try
    let sub_conditions = Symbolic_path_condition.slice path_condition in
    <span data-count="242">l</span>et models =
      List.map
        (fun pc -&gt;
          <span data-count="264">m</span>atch Solver.get_sat_model s pc with
          | <span data-count="264">`</span>Model model -&gt; model
          | <span data-count="0">`</span>Unknown -&gt;
            (* it can happen if the solver is interrupted, otherwise it is an error, we raise, so the function can return an option that will be handled by the called *)
            raise Unknown
          | `Unsat -&gt;
            (* it can not happen otherwise it means we reached an unreachable branch (or added garbage to the PC and did something wrong, who knows... :-) *)
            assert false )
        sub_conditions
    in
    (* We build the new complete model by merging all "sub models" *)
    <span data-count="242">l</span>et model = Hashtbl.create 64 in
    <span data-count="242">L</span>ist.iter (Hashtbl.ite<span data-count="242">r</span> (Hashtbl.ad<span data-count="242">d</span> model)) models;
    <span data-count="242">S</span>ome model
  with <span data-count="0">U</span>nknown -&gt; None

let model_of_set (S (solver_module, s)) ~symbol_scopes ~set =
  <span data-count="1188">l</span>et module Solver = (val solver_module) in
  let symbols = Symbol_scope.only_symbols symbol_scopes in
  <span data-count="1188">S</span>olver.get_sat_model ~symbols s set

let empty_stats = Smtml.Statistics.Map.empty

let stats_are_empty = Smtml.Statistics.Map.is_empty

let interrupt_all () =
  <span data-count="2">l</span>et solvers = Atomic.get instances in
  <span data-count="2">L</span>ist.iter
    (fun (S (solver_module, s)) -&gt;
      <span data-count="2">l</span>et module Solver = (val solver_module) in
      Solver.interrupt s )
    solvers

let get_all_stats ~wait_for_all_domains =
  <span data-count="2">i</span>f not (Log.is_bench_enable<span data-count="2">d</span> ()) then <span data-count="0">e</span>mpty_stats
  else <span data-count="2">b</span>egin
    (* interrupt_all is unreliable but is a best effort to try to make sure we don't wait too long on really long requests.
     The reliable alternative would be to backup the statistics before each SMT request when in benchmark mode, but this would be too costly and lead to less accurate requests than random failures... *)
    interrupt_all ();
    <span data-count="2">i</span>f Log.is_debug_enabled () then
      (* we only do this in debug mode because otherwise it makes performances very bad *)
      <span data-count="0">w</span>ait_for_all_domain<span data-count="0">s</span> ();

    <span data-count="2">l</span>et solvers = Atomic.get instances in
    <span data-count="2">L</span>ist.fold_left
      (fun stats_acc (S (solver_module, s)) -&gt;
        <span data-count="2">l</span>et module Solver = (val solver_module) in
        let stats =
          try Solver.get_statistic<span data-count="2">s</span> s
          with <span data-count="0">Z</span>3.Error _ -&gt;
            Logs.warn (fun m -&gt;
              <span data-count="0">m</span>
                "could not fetch the statistics of one solver because it was \
                 canceled, used empty stats instead" );
            <span data-count="0">e</span>mpty_stats
        in
        Smtml.Statistics.merge stats stats_acc )
      empty_stats solvers
  end

let pp_stats = Smtml.Statistics.pp
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
