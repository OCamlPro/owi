<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>cmd_sym.ml &mdash; Coverage report</title>
    <meta name="description" content="90.54% coverage in src/cmd/cmd_sym.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/cmd/</span>cmd_sym.ml
        </a>
      </h1>
      <h2>90.54%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:17.52%"></span>
      <span class="unvisited" style="top:18.38%"></span>
      <span class="unvisited" style="top:19.23%"></span>
      <span class="unvisited" style="top:20.09%"></span>
      <span class="unvisited" style="top:22.22%"></span>
      <span class="unvisited" style="top:22.65%"></span>
      <span class="some-visited" style="top:35.90%"></span>
      <span class="some-visited" style="top:36.75%"></span>
      <span class="unvisited" style="top:38.89%"></span>
      <span class="unvisited" style="top:46.15%"></span>
      <span class="unvisited" style="bottom:36.32%"></span>
      <span class="some-visited" style="bottom:20.94%"></span>
      <span class="some-visited" style="bottom:19.23%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span class="visited"> </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span class="visited"> </span>
<a id="L27"></a><span class="visited"> </span>
<a id="L28"></a><span class="visited"> </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span class="visited"> </span>
<a id="L31"></a><span class="visited"> </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span class="visited"> </span>
<a id="L34"></a><span class="visited"> </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span class="visited"> </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span class="unvisited"> </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span class="unvisited"> </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span class="unvisited"> </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span class="unvisited"> </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="unvisited"> </span>
<a id="L53"></a><span class="unvisited"> </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span class="visited"> </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="visited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span class="some-visited"> </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="some-visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="unvisited"> </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span > </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="unvisited"> </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span class="visited"> </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span class="visited"> </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span class="visited"> </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span class="visited"> </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span class="visited"> </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span class="visited"> </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span class="visited"> </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span class="visited"> </span>
<a id="L149"></a><span class="unvisited"> </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span class="visited"> </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span class="visited"> </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span > </span>
<a id="L161"></a><span > </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span class="visited"> </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span class="visited"> </span>
<a id="L168"></a><span class="visited"> </span>
<a id="L169"></a><span class="visited"> </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span class="visited"> </span>
<a id="L185"></a><span class="some-visited"> </span>
<a id="L186"></a><span > </span>
<a id="L187"></a><span class="visited"> </span>
<a id="L188"></a><span > </span>
<a id="L189"></a><span class="some-visited"> </span>
<a id="L190"></a><span > </span>
<a id="L191"></a><span > </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span > </span>
<a id="L196"></a><span class="visited"> </span>
<a id="L197"></a><span > </span>
<a id="L198"></a><span class="visited"> </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span > </span>
<a id="L203"></a><span > </span>
<a id="L204"></a><span > </span>
<a id="L205"></a><span > </span>
<a id="L206"></a><span class="visited"> </span>
<a id="L207"></a><span class="visited"> </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span > </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span > </span>
<a id="L212"></a><span > </span>
<a id="L213"></a><span > </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span > </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span class="visited"> </span>
<a id="L219"></a><span > </span>
<a id="L220"></a><span class="visited"> </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span > </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span class="visited"> </span>
<a id="L226"></a><span > </span>
<a id="L227"></a><span class="visited"> </span>
<a id="L228"></a><span class="visited"> </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span > </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
</pre>
<pre><code class="ocaml">(* SPDX-License-Identifier: AGPL-3.0-or-later *)
(* Copyright © 2021-2024 OCamlPro *)
(* Written by the Owi programmers *)

open Bos
open Syntax
module Expr = Smtml.Expr
module Choice = Symbolic_choice_with_memory

type fail_mode =
  | Trap_only
  | Assertion_only
  | Both

let link_symbolic_modules link_state =
  <span data-count="404">l</span>et func_typ = Symbolic.Extern_func.extern_type in
  let link_state =
    Link.extern_module' link_state ~name:"symbolic" ~func_typ
      Symbolic_wasm_ffi.symbolic_extern_module
  in
  <span data-count="404">L</span>ink.extern_module' link_state ~name:"summaries" ~func_typ
    Symbolic_wasm_ffi.summaries_extern_module

let run_file ~entry_point ~unsafe ~rac ~srac ~optimize ~invoke_with_symbols _pc
  filename =
  <span data-count="403">l</span>et* m = Compile.File.until_binary_validat<span data-count="403">e</span> ~unsafe ~rac ~srac filename in
  <span data-count="402">l</span>et* m = Cmd_utils.set_entry_poin<span data-count="402">t</span> entry_point invoke_with_symbols m in
  <span data-count="401">l</span>et link_state = link_symbolic_modules Link.empty_state in

  <span data-count="401">l</span>et+ m, link_state =
    Compile.Binary.until_lin<span data-count="401">k</span> ~unsafe ~optimize ~name:None link_state m
  in
  <span data-count="401">l</span>et m = Symbolic.convert_module_to_run m in
  <span data-count="401">I</span>nterpret.Symbolic.modul link_state.envs m

let print_bug ~model_format ~labels ~model_out_file ~id ~no_value
  ~no_stop_at_failure ~no_assert_failure_expression_printing ~breadcrumbs
  ~with_breadcrumbs =
  <span data-count="222">l</span>et to_string model labels =
    <span data-count="222">m</span>atch model_format with
    | <span data-count="0">C</span>md_utils.Json -&gt;
      let json = Smtml.Model.to_json model in
      <span data-count="0">l</span>et labels_json =
        `List
          (List.ma<span data-count="0">p</span>
             (fun (id, name) -&gt;
               <span data-count="0">`</span>Assoc [ ("id", `Int id); ("name", `String name) ] )
             labels )
      in
      let json =
        match json with
        | <span data-count="0">`</span>Assoc fields -&gt; `Assoc (("labels", labels_json) :: fields)
        | <span data-count="0">_</span> -&gt; json
      in
      Yojson.to_string json
    | <span data-count="222">S</span>cfg -&gt;
      let scfg = Smtml.Model.to_scfg ~no_value model in
      <span data-count="222">l</span>et model = Scfg.Query.get_dir_exn "model" scfg in
      <span data-count="222">l</span>et lbls =
        List.map
          (fun (id, lbl_name) -&gt;
            <span data-count="2">{</span> Scfg.Types.name = "label"
            ; params = [ string_of_in<span data-count="2">t</span> id; lbl_name ]
            ; children = []
            } )
          labels
      in
      <span data-count="222">l</span>et children =
        if with_breadcrumbs then
          <span data-count="1">l</span>et bcrumbs =
            [ { Scfg.Types.name = "breadcrumbs"
              ; params =
                  List.ma<span data-count="1">p</span> (fun i -&gt; <span data-count="5">F</span>mt.str "%ld" i) (List.re<span data-count="1">v</span> breadcrumbs)
              ; children = []
              }
            ]
          in
          model.children @ lbls @ bcrumbs
        else <span data-count="221">m</span>odel.children @ lbls
      in
      Fmt.str "%a" Scfg.Pp.directive { model with children }
  in
  let to_file path model =
    <span data-count="3">l</span>et model_ext = match model_format with <span data-count="0">J</span>son -&gt; "json" | <span data-count="3">S</span>cfg -&gt; "scfg" in
    let contains_ext =
      Fpath.has_ex<span data-count="3">t</span> ".json" pat<span data-count="0">h</span> || Fpath.has_ex<span data-count="3">t</span> ".scfg" pat<span data-count="1">h</span>
    in
    let* path =
      let* () =
        if contains_ext &amp;&amp; (<span data-count="1">n</span>o<span data-count="1">t</span> @@ Fpath.has_ex<span data-count="1">t</span> model_ext path) then
          <span data-count="0">F</span>mt.error_ms<span data-count="0">g</span>
            "Given model file extension is not compatible with the current \
             model format"
        else <span data-count="3">O</span>k ()
      in
      <span data-count="3">l</span>et path = Fpath.to_string @@ Fpath.rem_ex<span data-count="3">t</span> path in
      <span data-count="3">l</span>et base =
        Fpath.v (if no_stop_at_failure then <span data-count="2">F</span>mt.st<span data-count="2">r</span> "%s_%d" path id else <span data-count="1">p</span>ath)
      in
      <span data-count="3">O</span>k (Fpath.add_ex<span data-count="3">t</span> model_ext base)
    in
    <span data-count="3">B</span>os.OS.File.write path (to_strin<span data-count="3">g</span> model labels)
  in
  function
  | <span data-count="165">`</span>ETrap (tr, model, _, _) -&gt; (
    Logs.err (fun m -&gt; <span data-count="165">m</span> "Trap: %s" (Result.err_to_strin<span data-count="165">g</span> tr));
    <span data-count="165">m</span>atch model_out_file with
    | <span data-count="0">S</span>ome path -&gt; to_file path model
    | <span data-count="165">N</span>one -&gt; begin
      Logs.app (fun m -&gt; <span data-count="165">m</span> "%s" (to_strin<span data-count="165">g</span> model labels));
      <span data-count="165">O</span>k ()
    end )
  | <span data-count="57">`</span>EAssert (assertion, model, _, _) -&gt; (
    if no_assert_failure_expression_printing then begin
      <span data-count="10">L</span>ogs.er<span data-count="10">r</span> (fun m -&gt; <span data-count="10">m</span> "Assert failure")
    end
    else begin
      <span data-count="47">L</span>ogs.er<span data-count="47">r</span> (fun m -&gt; <span data-count="47">m</span> "Assert failure: %a" Expr.pp assertion)
    end;
    match model_out_file with
    | <span data-count="3">S</span>ome path -&gt; to_file path model
    | <span data-count="54">N</span>one -&gt; begin
      Logs.app (fun m -&gt; <span data-count="54">m</span> "%s" (to_strin<span data-count="54">g</span> model labels));
      <span data-count="54">O</span>k ()
    end )

let print_and_count_failures ~model_format ~model_out_file ~no_value
  ~no_assert_failure_expression_printing ~workspace ~no_stop_at_failure
  ~count_acc ~results ~with_breadcrumbs =
  <span data-count="404">l</span>et test_suite_dir = Fpath.(workspace / "test-suite") in
  let* (_created : bool) =
    if not no_value then <span data-count="295">O</span>S.Dir.creat<span data-count="295">e</span> test_suite_dir else <span data-count="109">O</span>k false
  in

  <span data-count="404">l</span>et rec aux count_acc results =
    <span data-count="578">m</span>atch results () with
    | <span data-count="356">S</span>eq.Nil -&gt; Ok count_acc
    | <span data-count="222">S</span>eq.Cons ((result, _thread), tl) -&gt;
      let* model =
        match result with
        | ( <span data-count="57">`</span>EAssert (_, model, labels, breadcrumbs)
          | <span data-count="165">`</span>ETrap (_, model, labels, breadcrumbs) ) as bug -&gt;
          let* () =
            print_bu<span data-count="222">g</span> ~model_format ~labels ~model_out_file ~id:count_acc
              ~no_value ~no_stop_at_failure ~breadcrumbs
              ~no_assert_failure_expression_printing ~with_breadcrumbs bug
          in
          <span data-count="222">O</span>k model
        | <span data-count="0">`</span>Error e -&gt; Error e
      in
      <span data-count="222">l</span>et count_acc = succ count_acc in
      <span data-count="222">l</span>et* () =
        if not no_value then
          <span data-count="113">l</span>et testcase = Smtml.Model.get_bindings model |&gt; <span data-count="113">L</span>ist.map snd in
          <span data-count="113">C</span>md_utils.write_testcas<span data-count="113">e</span> ~dir:test_suite_dir testcase
        else <span data-count="109">O</span>k ()
      in
      <span data-count="222">i</span>f no_stop_at_failure then <span data-count="174">a</span>ux count_acc tl else <span data-count="48">O</span>k count_acc
  in
  aux count_acc results

let sort_results deterministic_result_order results =
  <span data-count="404">i</span>f deterministic_result_order then
    <span data-count="31">r</span>esults
    |&gt; Seq.map (function <span data-count="35">(</span>_, thread) as x -&gt;
         (x, List.re<span data-count="35">v</span> @@ Thread_with_memory.breadcrumb<span data-count="35">s</span> thread) )
    |&gt; <span data-count="31">L</span>ist.of_seq
    |&gt; <span data-count="31">L</span>ist.sort (fun (_, bc1) (_, bc2) -&gt;
         <span data-count="10">L</span>ist.compare Prelude.Int32.compare bc1 bc2 )
    |&gt; <span data-count="31">L</span>ist.to_seq |&gt; <span data-count="31">S</span>eq.map fst
  else <span data-count="373">r</span>esults

let handle_result ~workers ~no_stop_at_failure ~no_value
  ~no_assert_failure_expression_printing ~deterministic_result_order ~fail_mode
  ~workspace ~solver ~model_format ~model_out_file ~with_breadcrumbs
  (result : unit Symbolic.Choice.t) =
  <span data-count="404">l</span>et thread = Thread_with_memory.init () in
  <span data-count="404">l</span>et res_queue = Wq.make () in
  <span data-count="404">l</span>et path_count = Atomic.make 0 in
  <span data-count="404">l</span>et callback v =
    <span data-count="1692">l</span>et open Symbolic_choice_intf in
    Atomic.incr path_count;
    <span data-count="1693">m</span>atch (fail_mode, v) with
    | <span data-count="1469">_</span>, (EVal (), _) -&gt; ()
    | <span data-count="165">(</span><span data-count="165">B</span>oth | <span data-count="0">T</span>rap_only), (ETrap (t, m, labels, breadcrumbs), thread) -&gt;
      Wq.push (`ETrap (t, m, labels, breadcrumbs), thread) res_queue
    | <span data-count="57">(</span><span data-count="56">B</span>oth | <span data-count="1">A</span>ssertion_only), (EAssert (e, m, labels, breadcrumbs), thread) -&gt;
      Wq.push (`EAssert (e, m, labels, breadcrumbs), thread) res_queue
    | <span data-count="1">(</span><span data-count="0">T</span>rap_only | <span data-count="1">A</span>ssertion_only), _ -&gt; ()
  in
  let join_handles =
    Symbolic_choice_with_memory.run ~workers solver result thread ~callback
      ~callback_init:(fun () -&gt; <span data-count="787">W</span>q.make_pledge res_queue)
      ~callback_end:(fun () -&gt; <span data-count="754">W</span>q.end_pledge res_queue)
  in
  <span data-count="404">l</span>et results =
    Wq.read_as_seq res_queue ~finalizer:(fun () -&gt;
      <span data-count="356">A</span>rray.iter Domain.join join_handles )
  in
  <span data-count="404">l</span>et results = sort_results deterministic_result_order results in
  <span data-count="404">l</span>et* count =
    print_and_count_failures ~model_format ~model_out_file ~no_value
      ~no_assert_failure_expression_printing ~workspace ~no_stop_at_failure
      ~count_acc:0 ~results ~with_breadcrumbs
  in
  <span data-count="404">L</span>ogs.info (fun m -&gt; <span data-count="7">m</span> "Completed paths: %d" (Atomic.ge<span data-count="7">t</span> path_count));
  <span data-count="404">l</span>et+ () = if count &gt; 0 then <span data-count="210">E</span>rror (`Found_bug count) else <span data-count="194">O</span>k () in
  <span data-count="194">L</span>ogs.app (fun m -&gt; <span data-count="194">m</span> "All OK!")

(* NB: This function propagates potential errors (Result.err) occurring
         during evaluation (OS, syntax error, etc.), except for Trap and Assert,
         which are handled here. Most of the computations are done in the Result
         monad, hence the let*. *)
let cmd ~unsafe ~rac ~srac ~optimize ~workers ~no_stop_at_failure ~no_value
  ~no_assert_failure_expression_printing ~deterministic_result_order ~fail_mode
  ~workspace ~solver ~files ~model_format ~entry_point ~invoke_with_symbols
  ~model_out_file ~with_breadcrumbs =
  <span data-count="403">l</span>et* workspace =
    match workspace with
    | <span data-count="212">S</span>ome path -&gt; Ok path
    | <span data-count="191">N</span>one -&gt; OS.Dir.tm<span data-count="191">p</span> "owi_sym_%s"
  in

  (* deterministic_result_order implies no_stop_at_failure *)
  <span data-count="403">l</span>et no_stop_at_failure = deterministic_result_orde<span data-count="31">r</span> || no_stop_at_failur<span data-count="137">e</span> in
  let pc = Choice.return () in
  <span data-count="403">l</span>et* result : unit Symbolic.Choice.t =
    list_fold_lef<span data-count="403">t</span>
      (run_file ~entry_point ~unsafe ~rac ~srac ~optimize ~invoke_with_symbols)
      pc files
  in
  <span data-count="401">h</span>andle_result ~fail_mode ~workers ~solver ~deterministic_result_order
    ~model_format ~no_value ~no_assert_failure_expression_printing ~workspace
    ~no_stop_at_failure ~model_out_file ~with_breadcrumbs result
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
