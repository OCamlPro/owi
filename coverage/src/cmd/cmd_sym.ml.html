<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>cmd_sym.ml &mdash; Coverage report</title>
    <meta name="description" content="93.63% coverage in src/cmd/cmd_sym.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/cmd/</span>cmd_sym.ml
        </a>
      </h1>
      <h2>93.63%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:6.13%"></span>
      <span class="unvisited" style="top:25.67%"></span>
      <span class="unvisited" style="top:27.59%"></span>
      <span class="unvisited" style="top:28.35%"></span>
      <span class="some-visited" style="bottom:48.28%"></span>
      <span class="some-visited" style="bottom:43.68%"></span>
      <span class="some-visited" style="bottom:26.82%"></span>
      <span class="some-visited" style="bottom:26.44%"></span>
      <span class="unvisited" style="bottom:24.14%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span class="visited"> </span>
<a id="L10"></a><span class="visited"> </span>
<a id="L11"></a><span class="visited"> </span>
<a id="L12"></a><span class="visited"> </span>
<a id="L13"></a><span class="visited"> </span>
<a id="L14"></a><span class="visited"> </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span class="unvisited"> </span>
<a id="L17"></a><span class="visited"> </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span class="visited"> </span>
<a id="L21"></a><span class="visited"> </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span class="visited"> </span>
<a id="L25"></a><span class="visited"> </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span class="visited"> </span>
<a id="L29"></a><span class="visited"> </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span > </span>
<a id="L41"></a><span class="visited"> </span>
<a id="L42"></a><span > </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span class="visited"> </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span > </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span class="visited"> </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span class="unvisited"> </span>
<a id="L68"></a><span > </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span class="visited"> </span>
<a id="L71"></a><span class="visited"> </span>
<a id="L72"></a><span class="unvisited"> </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span class="unvisited"> </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="visited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span class="visited"> </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span class="visited"> </span>
<a id="L82"></a><span > </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span class="visited"> </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span > </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span > </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span > </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span > </span>
<a id="L112"></a><span class="visited"> </span>
<a id="L113"></a><span > </span>
<a id="L114"></a><span > </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span class="visited"> </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span > </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span class="some-visited"> </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span class="visited"> </span>
<a id="L143"></a><span class="visited"> </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span class="visited"> </span>
<a id="L147"></a><span class="some-visited"> </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span class="visited"> </span>
<a id="L158"></a><span > </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span class="visited"> </span>
<a id="L162"></a><span class="visited"> </span>
<a id="L163"></a><span class="visited"> </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span > </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span class="visited"> </span>
<a id="L176"></a><span class="visited"> </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span class="visited"> </span>
<a id="L179"></a><span class="visited"> </span>
<a id="L180"></a><span class="visited"> </span>
<a id="L181"></a><span > </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span > </span>
<a id="L186"></a><span > </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span > </span>
<a id="L189"></a><span > </span>
<a id="L190"></a><span > </span>
<a id="L191"></a><span class="some-visited"> </span>
<a id="L192"></a><span class="some-visited"> </span>
<a id="L193"></a><span > </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span > </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span class="visited"> </span>
<a id="L198"></a><span class="unvisited"> </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span class="visited"> </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span > </span>
<a id="L205"></a><span class="visited"> </span>
<a id="L206"></a><span class="visited"> </span>
<a id="L207"></a><span class="visited"> </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span > </span>
<a id="L213"></a><span > </span>
<a id="L214"></a><span class="visited"> </span>
<a id="L215"></a><span class="visited"> </span>
<a id="L216"></a><span class="visited"> </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span class="visited"> </span>
<a id="L219"></a><span > </span>
<a id="L220"></a><span class="visited"> </span>
<a id="L221"></a><span > </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span class="visited"> </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span class="visited"> </span>
<a id="L226"></a><span class="visited"> </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span class="visited"> </span>
<a id="L229"></a><span class="visited"> </span>
<a id="L230"></a><span class="visited"> </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span > </span>
<a id="L235"></a><span class="visited"> </span>
<a id="L236"></a><span class="visited"> </span>
<a id="L237"></a><span > </span>
<a id="L238"></a><span class="visited"> </span>
<a id="L239"></a><span class="visited"> </span>
<a id="L240"></a><span > </span>
<a id="L241"></a><span class="visited"> </span>
<a id="L242"></a><span class="visited"> </span>
<a id="L243"></a><span class="visited"> </span>
<a id="L244"></a><span > </span>
<a id="L245"></a><span > </span>
<a id="L246"></a><span > </span>
<a id="L247"></a><span > </span>
<a id="L248"></a><span class="visited"> </span>
<a id="L249"></a><span class="visited"> </span>
<a id="L250"></a><span class="visited"> </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span class="visited"> </span>
<a id="L253"></a><span class="visited"> </span>
<a id="L254"></a><span class="visited"> </span>
<a id="L255"></a><span > </span>
<a id="L256"></a><span class="visited"> </span>
<a id="L257"></a><span class="visited"> </span>
<a id="L258"></a><span class="visited"> </span>
<a id="L259"></a><span > </span>
<a id="L260"></a><span class="visited"> </span>
<a id="L261"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
</pre>
<pre><code class="ocaml">open Syntax
module Expr = Smtml.Expr
module Value = Symbolic_value
module Choice = Symbolic.P.Choice

let symbolic_extern_module :
  Symbolic.P.Extern_func.extern_func Link.extern_module =
  let sym_cnt = Atomic.make 0 in
  <span data-count="620">l</span>et symbol ty () : Value.int32 Choice.t =
    <span data-count="1277">l</span>et id = Atomic.fetch_and_add sym_cnt 1 in
    <span data-count="1277">l</span>et sym = Format.kasprintf (Smtml.Symbol.mak<span data-count="1277">e</span> ty) "symbol_%d" id in
    <span data-count="1277">l</span>et sym_expr = Expr.mk_symbol sym in
    <span data-count="1277">C</span>hoice.with_thread (fun thread -&gt;
        <span data-count="1277">t</span>hread.symbol_set &lt;- sym :: thread.symbol_set;
        match ty with
        | <span data-count="0">T</span>y_bitv 8 -&gt; Expr.make (Cvtop (Ty_bitv 32, Zero_extend 24, sym_expr))
        | <span data-count="1277">_</span> -&gt; sym_expr )
  in
  let assume_i32 (i : Value.int32) : unit Choice.t =
    <span data-count="728">l</span>et c = Value.I32.to_bool i in
    <span data-count="728">C</span>hoice.add_pc c
  in
  let assume_positive_i32 (i : Value.int32) : unit Choice.t =
    <span data-count="6">l</span>et c = Value.I32.ge i Value.I32.zero in
    <span data-count="6">C</span>hoice.add_pc c
  in
  let assert_i32 (i : Value.int32) : unit Choice.t =
    <span data-count="9592">l</span>et c = Value.I32.to_bool i in
    <span data-count="9594">C</span>hoice.assertion c
  in
  (* we need to describe their types *)
  let functions =
    [ ( "i8_symbol"
      , Symbolic.P.Extern_func.Extern_func
          (Func (UArg Res, R1 I32), symbo<span data-count="620">l</span> (Ty_bitv 8)) )
    ; ( "i32_symbol"
      , Symbolic.P.Extern_func.Extern_func
          (Func (UArg Res, R1 I32), symbo<span data-count="620">l</span> (Ty_bitv 32)) )
    ; ( "i64_symbol"
      , Symbolic.P.Extern_func.Extern_func
          (Func (UArg Res, R1 I64), symbo<span data-count="620">l</span> (Ty_bitv 64)) )
    ; ( "f32_symbol"
      , Symbolic.P.Extern_func.Extern_func
          (Func (UArg Res, R1 F32), symbo<span data-count="620">l</span> (Ty_fp 32)) )
    ; ( "f64_symbol"
      , Symbolic.P.Extern_func.Extern_func
          (Func (UArg Res, R1 F64), symbo<span data-count="620">l</span> (Ty_fp 64)) )
    ; ( "assume"
      , Symbolic.P.Extern_func.Extern_func
          (Func (Arg (I32, Res), R0), assume_i32) )
    ; ( "assume_positive_i32"
      , Symbolic.P.Extern_func.Extern_func
          (Func (Arg (I32, Res), R0), assume_positive_i32) )
    ; ( "assert"
      , Symbolic.P.Extern_func.Extern_func
          (Func (Arg (I32, Res), R0), assert_i32) )
    ]
  in
  { functions }

let summaries_extern_module :
  Symbolic.P.Extern_func.extern_func Link.extern_module =
  let open Expr in
  let i32 v =
    <span data-count="9883">m</span>atch view v with
    | <span data-count="9881">V</span>al (Num (I32 v)) -&gt; v
    | <span data-count="0">_</span> -&gt; Log.err {|alloc: cannot allocate base pointer "%a"|} Expr.pp v
  in
  let ptr v =
    <span data-count="2437">m</span>atch view v with
    | <span data-count="2438">P</span>tr (b, _) -&gt; b
    | <span data-count="0">_</span> -&gt; Log.err {|free: cannot fetch pointer base of "%a"|} Expr.pp v
  in
  let abort () : unit Choice.t = <span data-count="0">C</span>hoice.add_pc @@ Value.Bool.cons<span data-count="0">t</span> false in
  let alloc (base : Value.int32) (size : Value.int32) : Value.int32 Choice.t =
    <span data-count="9886">l</span>et base : int32 = i3<span data-count="9880">2</span> base in
    Choice.with_thread (fun t -&gt;
        <span data-count="9878">l</span>et memories = Thread.memories t in
        <span data-count="9884">S</span>ymbolic_memory.iter
          (fun tbl -&gt;
            <span data-count="9878">S</span>ymbolic_memory.ITbl.iter
              (fun _ (m : Symbolic_memory.t) -&gt;
                <span data-count="9877">S</span>ymbolic_memory.replace_size m base size )
              tbl )
          memories;
        <span data-count="9888">E</span>xpr.make (Ptr (base, Value.const_i3<span data-count="9887">2</span> 0l)) )
  in
  let free (p : Value.int32) : unit Choice.t =
    <span data-count="2438">l</span>et base = ptr p in
    <span data-count="2438">C</span>hoice.with_thread (fun t -&gt;
        <span data-count="2436">l</span>et memories = Thread.memories t in
        <span data-count="2435">S</span>ymbolic_memory.iter
          (fun tbl -&gt;
            <span data-count="2438">S</span>ymbolic_memory.ITbl.iter
              (fun _ (m : Symbolic_memory.t) -&gt; <span data-count="2437">S</span>ymbolic_memory.free m base)
              tbl )
          memories )
  in
  let functions =
    [ ( "alloc"
      , Symbolic.P.Extern_func.Extern_func
          (Func (Arg (I32, Arg (I32, Res)), R1 I32), alloc) )
    ; ( "dealloc"
      , Symbolic.P.Extern_func.Extern_func (Func (Arg (I32, Res), R0), free) )
    ; ("abort", Symbolic.P.Extern_func.Extern_func (Func (UArg Res, R0), abort))
    ]
  in
  { functions }

let ( let*/ ) (t : 'a Result.t) (f : 'a -&gt; 'b Result.t Choice.t) :
  'b Result.t Choice.t =
  <span data-count="665">m</span>atch t with <span data-count="1">E</span>rror e -&gt; Choice.return (Error e) | <span data-count="664">O</span>k x -&gt; f x

let simplify_then_link_then_run ~unsafe ~optimize (pc : unit Result.t Choice.t)
  (m : Text.modul) =
  <span data-count="332">l</span>et link_state = Link.empty_state in
  let link_state =
    Link.extern_module' link_state ~name:"symbolic"
      ~func_typ:Symbolic.P.Extern_func.extern_type symbolic_extern_module
  in
  <span data-count="332">l</span>et link_state =
    Link.extern_module' link_state ~name:"summaries"
      ~func_typ:Symbolic.P.Extern_func.extern_type summaries_extern_module
  in
  <span data-count="332">l</span>et*/ to_run, link_state =
    let has_start =
      List.exists (function <span data-count="166">T</span>ext.MStart _ -&gt; true | <span data-count="7402">_</span> -&gt; false) m.fields
    in
    <span data-count="332">l</span>et has_start_id_function =
      List.exists
        (function <span data-count="166">T</span>ext.MFunc { id = Some "_start"; _ } -&gt; true | <span data-count="6247">_</span> -&gt; false)
        m.fields
    in
    <span data-count="332">l</span>et fields =
      if has_star<span data-count="166">t</span> || not has_start_id_functio<span data-count="0">n</span> then <span data-count="166">m</span>.fields
      else <span data-count="166">M</span>Start (Text "_start") :: m.fields
    in
    let m = { m with fields } in
    let+ m, state =
      Compile.until_lin<span data-count="332">k</span> ~unsafe link_state ~optimize ~name:None m
    in
    <span data-count="332">l</span>et m = Symbolic.convert_module_to_run m in
    <span data-count="332">(</span>m, state)
  in
  <span data-count="332">l</span>et c = (Interpret.SymbolicP.modu<span data-count="332">l</span> link_state.envs) to_run in
  <span data-count="332">C</span>hoice.bind pc (fun r -&gt;
      <span data-count="332">m</span>atch r with <span data-count="0">E</span>rror _ -&gt; Choice.return r | <span data-count="332">O</span>k () -&gt; c )

let run_file ~unsafe ~optimize pc filename =
  <span data-count="333">l</span>et*/ m0dule = Parse.Module.from_fil<span data-count="333">e</span> filename in
  <span data-count="332">s</span>implify_then_link_then_run ~unsafe ~optimize pc m0dule

let get_model ~symbols solver pc =
  <span data-count="1384">a</span>ssert <span data-count="1384">(</span>`Sat = Solver.Z3Batch.chec<span data-count="1384">k</span> solver pc);
  match Solver.Z3Batch.model ~symbols solver with
  | None -&gt; assert false
  | <span data-count="1384">S</span>ome model -&gt; model

let out_testcase ~dst ~err testcase =
  <span data-count="1183">l</span>et o = Xmlm.make_output ~nl:true ~indent:(Some 2) dst in
  <span data-count="1183">l</span>et tag ?(atts = <span data-count="20103">[</span>]) name = <span data-count="20187">(</span>("", name), atts) in
  let atts = if err then <span data-count="84">S</span>ome [ (("", "coversError"), "true") ] else <span data-count="1099">N</span>one in
  let to_string v = <span data-count="19004">F</span>ormat.asprintf "%a" Smtml.Value.pp_num v in
  let input v = <span data-count="19004">`</span>El (ta<span data-count="19004">g</span> "input", [ `Data (to_strin<span data-count="19004">g</span> v) ]) in
  let testcase = `El (ta<span data-count="1183">g</span> ?atts "testcase", List.ma<span data-count="1183">p</span> input testcase) in
  let dtd =
    {|&lt;!DOCTYPE testcase PUBLIC "+//IDN sosy-lab.org//DTD test-format testcase 1.1//EN" "https://sosy-lab.org/test-format/testcase-1.1.dtd"&gt;|}
  in
  Xmlm.output o (`Dtd (Some dtd));
  <span data-count="1183">X</span>mlm.output_tree Fun.id o testcase

let write_testcase =
  let cnt = ref 0 in
  fun ~dir ~err testcase -&gt;
    <span data-count="1183">i</span>ncr cnt;
    <span data-count="1183">l</span>et name = Format.ksprintf Fpath.v "testcase-%d.xml" !cnt in
    <span data-count="1183">l</span>et path = Fpath.append dir name in
    <span data-count="1183">l</span>et* res =
      Bos.OS.File.with_o<span data-count="1183">c</span> path
        (fun chan () -&gt; <span data-count="1183">O</span>k (out_testcas<span data-count="1183">e</span> ~dst:(`Channel chan) ~err testcase))
        ()
    in
    <span data-count="1183">r</span>es

(* NB: This function propagates potential errors (Result.err) occurring
   during evaluation (OS, syntax error, etc.), except for Trap and Assert,
   which are handled here. Most of the computations are done in the Result
   monad, hence the let*. *)
let cmd profiling debug unsafe optimize workers no_stop_at_failure no_values
  deterministic_result_order (workspace : Fpath.t) files =
  <span data-count="333">i</span>f profiling then <span data-count="0">L</span>og.profiling_on := true;
  <span data-count="333">i</span>f debug then <span data-count="0">L</span>og.debug_on := true;
  (* deterministic_result_order implies no_stop_at_failure *)
  <span data-count="333">l</span>et no_stop_at_failure = deterministic_result_orde<span data-count="28">r</span> || no_stop_at_failur<span data-count="137">e</span> in
  let* () =
    match Bos.OS.Dir.create ~path:true ~mode:0o755 workspace with
    | <span data-count="20">O</span>k true | <span data-count="313">O</span>k false -&gt; Ok ()
    | <span data-count="0">E</span>rror (`Msg msg) -&gt; Error (`Msg msg)
  in
  <span data-count="333">l</span>et pc = Choice.return (Ok ()) in
  <span data-count="333">l</span>et solver = Solver.Z3Batch.create () in
  <span data-count="333">l</span>et result = List.fold_left (run_file ~unsafe ~optimize) pc files in
  <span data-count="333">l</span>et thread : Thread.t = Thread.creat<span data-count="333">e</span> () in
  let results = Choice.run ~workers result thread in
  <span data-count="333">l</span>et print_bug = function
    | <span data-count="159">`</span>ETrap (tr, model) -&gt;
      Format.pp_std "Trap: %s@\n" (Trap.to_strin<span data-count="159">g</span> tr);
      <span data-count="159">F</span>ormat.pp_std "Model:@\n  @[&lt;v&gt;%a@]@." (Smtml.Model.pp ~no_values) model
    | <span data-count="20">`</span>EAssert (assertion, model) -&gt;
      Format.pp_std "Assert failure: %a@\n" Expr.pp assertion;
      <span data-count="20">F</span>ormat.pp_std "Model:@\n  @[&lt;v&gt;%a@]@." (Smtml.Model.pp ~no_values) model
  in
  let rec print_and_count_failures count_acc results =
    <span data-count="1706">m</span>atch results () with
    | <span data-count="322">S</span>eq.Nil -&gt; Ok count_acc
    | <span data-count="1384">S</span>eq.Cons ((result, thread), tl) -&gt;
      let pc = Thread.pc thread in
      <span data-count="1384">l</span>et symbols = thread.symbol_set in
      let model = get_model ~symbols solver pc in
      <span data-count="1384">l</span>et* is_err =
        let open Symbolic_choice.Multicore in
        match result with
        | <span data-count="20">E</span>Assert assertion -&gt;
          print_bug (`EAssert (assertion, model));
          <span data-count="20">O</span>k true
        | <span data-count="159">E</span>Trap tr -&gt;
          print_bug (`ETrap (tr, model));
          <span data-count="159">O</span>k true
        | <span data-count="1204">E</span>Val (Ok ()) -&gt; Ok false
        | <span data-count="1">E</span>Val (Error e) -&gt; Error e
      in
      <span data-count="1383">l</span>et count_acc = if is_err then <span data-count="179">s</span>uc<span data-count="179">c</span> count_acc else <span data-count="1204">c</span>ount_acc in
      let* () =
        if not no_values then
          <span data-count="1183">l</span>et testcase =
            List.sort compare (Smtml.Model.get_binding<span data-count="1183">s</span> model) |&gt; <span data-count="1183">L</span>ist.map snd
          in
          <span data-count="1183">w</span>rite_testcas<span data-count="1183">e</span> ~dir:workspace ~err:is_err testcase
        else <span data-count="200">O</span>k ()
      in
      <span data-count="1383">i</span>f (not is_err<span data-count="1204">)</span> || no_stop_at_failur<span data-count="169">e</span> then
        <span data-count="1373">p</span>rint_and_count_failures count_acc tl
      else <span data-count="10">O</span>k count_acc
  in
  let results =
    if deterministic_result_order then
      results
      |&gt; Seq.map (function <span data-count="82">(</span>_, th) as x -&gt;
           (x, List.re<span data-count="82">v</span> @@ Thread.breadcrumb<span data-count="82">s</span> th) )
      |&gt; <span data-count="28">L</span>ist.of_seq
      |&gt; <span data-count="28">L</span>ist.sort (fun (_, bc1) (_, bc2) -&gt;
             <span data-count="98">L</span>ist.compare Stdlib.Int32.compare bc1 bc2 )
      |&gt; <span data-count="28">L</span>ist.to_seq |&gt; <span data-count="56">S</span>eq.ma<span data-count="28">p</span> fst
    else <span data-count="305">r</span>esults
  in
  let* count = print_and_count_failure<span data-count="333">s</span> 0 results in
  <span data-count="332">i</span>f count &gt; 0 then <span data-count="169">E</span>rror (`Found_bug count)
  else <span data-count="163">b</span>egin
    Format.pp_std "All OK";
    <span data-count="163">O</span>k ()
  end
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
