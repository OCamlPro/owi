<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>cmd_sym.ml &mdash; Coverage report</title>
    <meta name="description" content="93.68% coverage in src/cmd/cmd_sym.ml">
    <link rel="stylesheet" href="../../coverage.css"/>
    <script src="../../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../../index.html">
          <span class="dirname">src/cmd/</span>cmd_sym.ml
        </a>
      </h1>
      <h2>93.68%</h2>
    </div>
    <div id="navbar">
      <span class="some-visited" style="top:31.39%"></span>
      <span class="some-visited" style="top:38.69%"></span>
      <span class="some-visited" style="bottom:48.18%"></span>
      <span class="some-visited" style="bottom:45.26%"></span>
      <span class="some-visited" style="bottom:3.65%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span class="visited"> </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span class="visited"> </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span class="visited"> </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span class="visited"> </span>
<a id="L34"></a><span class="visited"> </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span class="visited"> </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span class="visited"> </span>
<a id="L42"></a><span class="visited"> </span>
<a id="L43"></a><span class="some-visited"> </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="some-visited"> </span>
<a id="L54"></a><span class="visited"> </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span class="visited"> </span>
<a id="L59"></a><span class="visited"> </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span class="visited"> </span>
<a id="L70"></a><span class="visited"> </span>
<a id="L71"></a><span class="some-visited"> </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span class="visited"> </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span class="some-visited"> </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="visited"> </span>
<a id="L80"></a><span class="visited"> </span>
<a id="L81"></a><span > </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span > </span>
<a id="L84"></a><span class="visited"> </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span class="visited"> </span>
<a id="L88"></a><span class="visited"> </span>
<a id="L89"></a><span class="visited"> </span>
<a id="L90"></a><span class="visited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span class="visited"> </span>
<a id="L93"></a><span > </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span class="visited"> </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span > </span>
<a id="L105"></a><span class="visited"> </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span > </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="visited"> </span>
<a id="L114"></a><span class="visited"> </span>
<a id="L115"></a><span class="visited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span class="visited"> </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span class="visited"> </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span class="visited"> </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span class="some-visited"> </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span class="visited"> </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
</pre>
<pre><code class="ocaml">(* SPDX-License-Identifier: AGPL-3.0-or-later *)
(* Copyright Â© 2021-2024 OCamlPro *)
(* Written by the Owi programmers *)

open Syntax
module Expr = Smtml.Expr
module Choice = Symbolic_choice_with_memory

type fail_mode =
  [ `Trap_only
  | `Assertion_only
  | `Both
  ]

(* TODO: add a flag for this *)
let print_paths = false

let ( let*/ ) (t : 'a Result.t) (f : 'a -&gt; 'b Result.t Choice.t) :
  'b Result.t Choice.t =
  <span data-count="1138">m</span>atch t with <span data-count="1">E</span>rror e -&gt; Choice.return (Error e) | <span data-count="1137">O</span>k x -&gt; f x

let link_state =
  lazy
    <span data-count="379">(</span>let func_typ = Symbolic.Extern_func.extern_type in
     let link_state =
       Link.extern_module' Link.empty_state ~name:"symbolic" ~func_typ
         Symbolic_wasm_ffi.symbolic_extern_module
     in
     <span data-count="379">L</span>ink.extern_module' link_state ~name:"summaries" ~func_typ
       Symbolic_wasm_ffi.summaries_extern_module )

let run_file ~unsafe ~rac ~srac ~optimize pc filename =
  <span data-count="380">l</span>et*/ m = Compile.File.until_binary_validat<span data-count="380">e</span> ~unsafe ~rac ~srac filename in
  <span data-count="379">l</span>et*/ m = Cmd_utils.add_main_as_star<span data-count="379">t</span> m in
  <span data-count="379">l</span>et link_state = Lazy.force link_state in

  <span data-count="379">l</span>et*/ m, link_state =
    Compile.Binary.until_lin<span data-count="379">k</span> ~unsafe ~optimize ~name:None link_state m
  in
  <span data-count="379">l</span>et m = Symbolic.convert_module_to_run m in
  <span data-count="379">l</span>et c = Interpret.Symbolic.modul link_state.envs m in
  <span data-count="379">C</span>hoice.bind pc (fun r -&gt;
    <span data-count="379">m</span>atch r with <span data-count="0">E</span>rror _ -&gt; Choice.return r | <span data-count="379">O</span>k () -&gt; c )

(* NB: This function propagates potential errors (Result.err) occurring
   during evaluation (OS, syntax error, etc.), except for Trap and Assert,
   which are handled here. Most of the computations are done in the Result
   monad, hence the let*. *)
let cmd ~profiling ~debug ~unsafe ~rac ~srac ~optimize ~workers
  ~no_stop_at_failure ~no_value ~no_assert_failure_expression_printing
  ~deterministic_result_order ~fail_mode ~workspace ~solver ~files ~profile =
  <span data-count="380">O</span>ption.iter Stats.init_logger_to_file profile;
  <span data-count="380">i</span>f profiling then <span data-count="0">L</span>og.profiling_on := true;
  <span data-count="380">i</span>f debug then <span data-count="6">L</span>og.debug_on := true;
  (* deterministic_result_order implies no_stop_at_failure *)
  <span data-count="380">l</span>et no_stop_at_failure = deterministic_result_orde<span data-count="33">r</span> || no_stop_at_failur<span data-count="136">e</span> in
  let* _created_dir = Bos.OS.Dir.creat<span data-count="380">e</span> ~path:true ~mode:0o755 workspace in
  <span data-count="380">l</span>et pc = Choice.return (Ok ()) in
  <span data-count="380">l</span>et result =
    List.fold_left (run_file ~unsafe ~rac ~srac ~optimize) pc files
  in
  <span data-count="380">l</span>et thread = Thread_with_memory.init () in
  <span data-count="380">l</span>et res_queue = Wq.make () in
  <span data-count="380">l</span>et path_count = ref 0 in
  let callback v =
    <span data-count="1671">l</span>et open Symbolic_choice_intf in
    incr path_count;
    <span data-count="1673">m</span>atch (fail_mode, v) with
    | <span data-count="1469">_</span>, (EVal (Ok ()), _) -&gt; ()
    | <span data-count="1">_</span>, (EVal (Error e), thread) -&gt; Wq.push (`Error e, thread) res_queue
    | <span data-count="164">(</span><span data-count="164">`</span>Both | <span data-count="0">`</span>Trap_only), (ETrap (t, m), thread) -&gt;
      Wq.push (`ETrap (t, m), thread) res_queue
    | <span data-count="36">(</span><span data-count="35">`</span>Both | <span data-count="1">`</span>Assertion_only), (EAssert (e, m), thread) -&gt;
      Wq.push (`EAssert (e, m), thread) res_queue
    | <span data-count="1">(</span><span data-count="0">`</span>Trap_only | <span data-count="1">`</span>Assertion_only), _ -&gt; ()
  in
  let join_handles =
    Symbolic_choice_with_memory.run ~workers solver result thread ~callback
      ~callback_init:(fun () -&gt; <span data-count="749">W</span>q.make_pledge res_queue)
      ~callback_end:(fun () -&gt; <span data-count="723">W</span>q.end_pledge res_queue)
  in
  <span data-count="380">l</span>et results =
    Wq.read_as_seq res_queue ~finalizer:(fun () -&gt;
      <span data-count="351">A</span>rray.iter Domain.join join_handles )
  in
  <span data-count="380">l</span>et print_bug = function
    | <span data-count="164">`</span>ETrap (tr, model) -&gt;
      Fmt.pr "Trap: %s@\n" (Trap.to_strin<span data-count="164">g</span> tr);
      <span data-count="164">F</span>mt.pr "%s@\n" (Smtml.Model.to_scfg_strin<span data-count="164">g</span> ~no_value model)
    | <span data-count="35">`</span>EAssert (assertion, model) -&gt;
      if no_assert_failure_expression_printing then begin
        <span data-count="9">F</span>mt.p<span data-count="9">r</span> "Assert failure@\n"
      end
      else begin
        <span data-count="26">F</span>mt.p<span data-count="26">r</span> "Assert failure: %a@\n" Expr.pp assertion
      end;
      Fmt.pr "%s@\n" (Smtml.Model.to_scfg_strin<span data-count="35">g</span> ~no_value model)
  in
  let rec print_and_count_failures count_acc results =
    <span data-count="551">m</span>atch results () with
    | <span data-count="351">S</span>eq.Nil -&gt; Ok count_acc
    | <span data-count="200">S</span>eq.Cons ((result, _thread), tl) -&gt;
      let* model =
        match result with
        | (<span data-count="35">`</span>EAssert (_, model) | <span data-count="164">`</span>ETrap (_, model)) as bug -&gt;
          print_bug bug;
          <span data-count="199">O</span>k model
        | <span data-count="1">`</span>Error e -&gt; Error e
      in
      <span data-count="199">l</span>et count_acc = succ count_acc in
      <span data-count="199">l</span>et* () =
        if not no_value then
          <span data-count="90">l</span>et testcase = Smtml.Model.get_bindings model |&gt; <span data-count="90">L</span>ist.map snd in
          <span data-count="90">C</span>md_utils.write_testcas<span data-count="90">e</span> ~dir:workspace testcase
        else <span data-count="109">O</span>k ()
      in
      <span data-count="199">i</span>f no_stop_at_failure then <span data-count="171">p</span>rint_and_count_failures count_acc tl
      else <span data-count="28">O</span>k count_acc
  in
  let results =
    if deterministic_result_order then
      results
      |&gt; Seq.map (function <span data-count="34">(</span>_, thread) as x -&gt;
           (x, List.re<span data-count="34">v</span> @@ Thread_with_memory.breadcrumb<span data-count="34">s</span> thread) )
      |&gt; <span data-count="33">L</span>ist.of_seq
      |&gt; <span data-count="33">L</span>ist.sort (fun (_, bc1) (_, bc2) -&gt;
           <span data-count="9">L</span>ist.compare Prelude.Int32.compare bc1 bc2 )
      |&gt; <span data-count="33">L</span>ist.to_seq |&gt; <span data-count="66">S</span>eq.ma<span data-count="33">p</span> fst
    else <span data-count="347">r</span>esults
  in
  let* count = print_and_count_failure<span data-count="380">s</span> 0 results in
  <span data-count="379">i</span>f print_paths then <span data-count="0">F</span>mt.p<span data-count="0">r</span> "Completed paths: %d@." !path_count;
  <span data-count="379">i</span>f count &gt; 0 then <span data-count="189">E</span>rror (`Found_bug count)
  else <span data-count="190">b</span>egin
    Fmt.pr "All OK@.";
    <span data-count="190">O</span>k ()
  end
</code></pre>
      </div>
    </div>
    <script src="../../coverage.js"></script>
  </body>
</html>
